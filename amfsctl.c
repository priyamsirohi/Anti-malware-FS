#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#define LIST_ALL_PATTERNS 10
#define ADD_PATTERN 11
#define REMOVE_PATTERN 12
#define PAGE_SIZE 4096

struct plist {
	char *s;
	int len;
	struct plist *next;
};	


int main(int argc,  char *argv[])
{
	int c, cmd; 
	int err=0,fd, i;
	char *str=NULL, *mountpoint;
	extern char *optarg;
	extern int optind;
	
	
	while ((c = getopt(argc, argv, "la:r:")) != -1)
		switch (c) {
		case 'l':
			cmd=LIST_ALL_PATTERNS;
			str = (char *)malloc(PAGE_SIZE);
			break;
		case 'a':
			cmd = ADD_PATTERN;			
			str=(char *)optarg;
			
			break;
		case 'r':
			cmd = REMOVE_PATTERN;			
			str=(char *)optarg;
			
			break;
		case '?':
			printf("Invalid options");
			err = 1;
			break;
		}
	
	 
		
	 if (err) {
		err=-1;
		goto out;
		
	}
	
	if (optind < argc)	{/* these are the arguments after the command-line options */
		mountpoint = argv[optind];
		
	} else {
		printf("Mountpoint not specified, AMFSCTL FAILED\n");
		err=-1;
		goto out;
	}
	
	
	fd = open(mountpoint,O_RDONLY);
	if(fd<0)
	{
		printf(" %d (errno=%d)\n", err, errno);
		goto out;
	}

	err = ioctl(fd, cmd, str);
		if (err < 0) {
			printf ("ioctl failed:%d\n", err);
			goto out;
		}
		else if(err==300)
		{
			printf("Pattern not present in file\n");
		}
		else printf("\nSuccess\n");
		
	if(cmd==LIST_ALL_PATTERNS)
	{	

		printf("The contents of pattern file are : \n");
			for (i = 0; i < PAGE_SIZE; i++)
				{
					
					if(str[i]=='\0')
						printf("\n");
					
					else if (str[i]=='\n')
						break;

					else
					printf("%c", str[i]);
				}
			
				
			free(str);
	}		
		
			
		
	
	
	out:
	exit(err);
}
